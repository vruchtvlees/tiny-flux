var Dispatcher=function(){var t,e=this;e.phase=0,e.stores=[],e.register=function(t,i){if(1===e.phase)throw"Cannot register new store whilst dispatching!";e.stores.push({storeObj:t,callback:i})},e.dispatch=function(i){if(1===e.phase)throw"Cannot dispatch an action whilst another is already being dispatched";e.phase=1,t=[];for(var r=e.stores.length-1;r>=0;r--)e.stores[r].phase=0,e.stores[r].didEmitChange=!1;for(r=e.stores.length-1;r>=0;r--)s(i,e.stores[r]);for(r=t.length-1;r>=0;r--)t[r](i);e.phase=0},e.addPostDispatchCallback=function(i){1===e.phase&&-1===t.indexOf(i)&&t.push(i)},e.removePostDispatchCallback=function(i){if(1===e.phase){var s=t.indexOf(i);-1!==s&&(t[s]=function(){})}};var i=[],s=function(t,r){if(2!==r.phase){if(1===r.phase)throw"Cannot dispatch action: circular dependency amongst stores";r.phase=1,i.push(e.waitFor),e.waitFor=function(i){if(1===arguments.length){for(r=e.stores.length-1;r>=0&&e.stores[r].storeObj!==i;r--);if(r<0)throw"Unregistered store";s(t,e.stores[r])}else for(var r=0;r<arguments.length;r++)e.waitFor(arguments[r])},r.didEmitChange=r.callback(t),e.waitFor=i.pop(e.waitFor),r.phase=2}};return e.waitFor=function(){},e.didEmitChange=function(t){if(1!==arguments.length){for(var i=0;i<arguments.length;i++)if(e.didEmitChange(arguments[i]))return!0;return!1}for(i=e.stores.length-1;i>=0&&e.stores[i].storeObj!==t;i--);if(i<0)throw"Unregistered store";return e.stores[i].didEmitChange},e},Store=function(t){for(var e={},i=Object.keys(t),s=0;s<i.length;s++){var r=i[s],a=t[r];this[r]="function"==typeof a?a.bind(e):a}var n=[];this.addChangeListener=function(t){return n.push(t),t},this.removeChangeListener=function(t){var e=n.indexOf(t);if(-1!==e)if(this.dispatcher.removePostDispatchCallback(t),1!==n.length){var i=n.pop();i!==t&&(n[e]=i)}else n=[]};var o=!1;e.emitChange=function(){for(var t=n.length-1;t>=0;t--)this.dispatcher.addPostDispatchCallback(n[t]);o=!0}.bind(this);var h=this.callback;return this.callback=function(t){return o=!1,h(t),o},this.dispatcher.register(this,this.callback),this.initialize&&this.initialize(),this};module&&(module.exports={Dispatcher:Dispatcher,Store:Store});